<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Homework Assistant - TutionBuddy</title>
    
    <!-- Bootstrap CSS with Replit theme -->
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <style>
        .homework-card {
            transition: transform 0.2s ease-in-out;
            border-radius: 16px;
            background: var(--bs-gray-800);
            border: 1px solid var(--bs-gray-700);
        }
        
        .homework-card:hover {
            transform: translateY(-2px);
            border-color: var(--bs-primary);
        }
        
        .upload-area {
            border: 2px dashed var(--bs-gray-600);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: var(--bs-primary);
            background: var(--bs-gray-800);
        }
        
        .upload-area.dragover {
            border-color: var(--bs-success);
            background: var(--bs-success-bg-subtle);
        }
        
        .question-container {
            background: var(--bs-gray-900);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--bs-gray-700);
        }
        
        .hint-button {
            position: relative;
            overflow: hidden;
        }
        
        .hint-level-indicator {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            color: white;
            text-align: center;
            line-height: 24px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .hint-level-1 { background: linear-gradient(135deg, #28a745, #20c997); }
        .hint-level-2 { background: linear-gradient(135deg, #17a2b8, #6610f2); }
        .hint-level-3 { background: linear-gradient(135deg, #ffc107, #fd7e14); }
        .hint-level-4 { background: linear-gradient(135deg, #fd7e14, #dc3545); }
        .hint-level-5 { background: linear-gradient(135deg, #dc3545, #6f42c1); }
        
        .voice-button {
            position: relative;
            background: linear-gradient(135deg, #6610f2, #6f42c1);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .voice-button:hover {
            background: linear-gradient(135deg, #5a0fc7, #5d37a6);
            transform: scale(1.05);
        }
        
        .voice-button.listening {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .answer-textarea {
            background: var(--bs-gray-800);
            border: 1px solid var(--bs-gray-600);
            border-radius: 8px;
            color: var(--bs-body-color);
            padding: 12px;
            resize: vertical;
            min-height: 120px;
        }
        
        .answer-textarea:focus {
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
        }
        
        .progress-ring {
            width: 60px;
            height: 60px;
            border: 4px solid var(--bs-gray-600);
            border-top: 4px solid var(--bs-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .question-counter {
            background: var(--bs-primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .session-type-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .session-type-homework {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .session-type-worksheet {
            background: linear-gradient(135deg, #17a2b8, #6610f2);
            color: white;
        }
        
        .session-type-exam {
            background: linear-gradient(135deg, #fd7e14, #dc3545);
            color: white;
        }
        
        .audio-player {
            background: var(--bs-gray-800);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            border: 1px solid var(--bs-gray-600);
        }
        
        .document-preview {
            background: var(--bs-gray-900);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            border: 1px solid var(--bs-gray-700);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .feedback-positive {
            color: var(--bs-success);
            background: var(--bs-success-bg-subtle);
            border: 1px solid var(--bs-success-border-subtle);
        }
        
        .feedback-partial {
            color: var(--bs-warning);
            background: var(--bs-warning-bg-subtle);
            border: 1px solid var(--bs-warning-border-subtle);
        }
        
        .feedback-negative {
            color: var(--bs-danger);
            background: var(--bs-danger-bg-subtle);
            border: 1px solid var(--bs-danger-border-subtle);
        }
        
        .progress-ring {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Step formatting styles */
        .step-item {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 4px;
        }
        
        .step-number {
            color: #007bff;
            font-size: 1.1em;
        }
        
        .step-content {
            margin-top: 8px;
            line-height: 1.6;
        }
        
        .solution-item {
            background-color: #e7f3ff;
            border-left: 4px solid #17a2b8;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 4px;
        }
        
        .solution-header {
            color: #17a2b8;
            font-size: 1.1em;
        }
        
        .solution-content {
            margin-top: 8px;
            line-height: 1.6;
        }
        
        .answer-item {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 4px;
        }
        
        .answer-header {
            color: #28a745;
            font-size: 1.1em;
        }
        
        .answer-content {
            margin-top: 8px;
            line-height: 1.6;
        }
        
        .page-content {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background-color: #f8f9fa;
        }
        
        .content-text {
            font-size: 0.95em;
            line-height: 1.6;
            color: #495057;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i data-feather="book-open" class="me-2"></i>TutionBuddy
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/subjects">Subjects</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/ask">AI Tutor</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/interactive_reading">Voice Reading</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/homework">Homework Assistant</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/progress-report">Progress Report</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="display-6 mb-2">
                            <i data-feather="edit-3" class="me-3"></i>Homework & Worksheet Assistant
                        </h1>
                        <p class="lead text-muted">Upload your homework documents and get step-by-step guidance with voice support</p>
                    </div>
                    <div class="text-end">
                        <div class="session-type-badge session-type-homework" id="sessionTypeBadge">
                            Daily Homework
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Type Selection -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="homework-card p-4">
                    <h4 class="mb-3">
                        <i data-feather="layers" class="me-2"></i>Select Session Type
                    </h4>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sessionType" id="homeworkType" value="homework" checked>
                                <label class="form-check-label" for="homeworkType">
                                    <strong>📝 Daily Homework</strong><br>
                                    <small class="text-muted">Get help with your daily homework assignments</small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sessionType" id="worksheetType" value="worksheet">
                                <label class="form-check-label" for="worksheetType">
                                    <strong>🗂️ Weekly Worksheet</strong><br>
                                    <small class="text-muted">Complete your weekly worksheets step-by-step</small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sessionType" id="examType" value="exam">
                                <label class="form-check-label" for="examType">
                                    <strong>🏆 Exam Preparation</strong><br>
                                    <small class="text-muted">Practice with adaptive difficulty questions</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subject Selection -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="homework-card p-4">
                    <h4 class="mb-3">
                        <i data-feather="book" class="me-2"></i>Select Subject
                    </h4>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="subject" id="english" value="English">
                                <label class="form-check-label" for="english">English</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="subject" id="maths" value="Maths">
                                <label class="form-check-label" for="maths">Maths</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="subject" id="science" value="Science">
                                <label class="form-check-label" for="science">Science</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="subject" id="social" value="Social">
                                <label class="form-check-label" for="social">Social</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="subject" id="hindi" value="Hindi">
                                <label class="form-check-label" for="hindi">Hindi</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="subject" id="telugu" value="Telugu">
                                <label class="form-check-label" for="telugu">Telugu</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="subject" id="it" value="IT-Computers">
                                <label class="form-check-label" for="it">IT-Computers</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="subject" id="gk" value="GK">
                                <label class="form-check-label" for="gk">GK</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Upload Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="homework-card p-4">
                    <h4 class="mb-3">
                        <i data-feather="upload" class="me-2"></i>Upload Document
                    </h4>
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="documentFile" accept=".docx,.txt,.jpg,.jpeg,.png" style="display: none;">
                        <div class="upload-content">
                            <i data-feather="file-text" size="48" class="mb-3 text-muted"></i>
                            <h5>Drop your homework document here</h5>
                            <p class="text-muted">or click to browse files</p>
                            <small class="text-muted">Supports .docx, .txt, .jpg, .jpeg, .png files</small>
                        </div>
                    </div>
                    <div class="mt-3" id="uploadStatus" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="progress-ring me-3"></div>
                            <span>Processing document...</span>
                        </div>
                    </div>
                    <div class="mt-3" id="uploadResult" style="display: none;">
                        <div class="alert alert-success">
                            <i data-feather="check-circle" class="me-2"></i>
                            <span id="uploadMessage"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Preview -->
        <div class="row mb-4" id="documentPreview" style="display: none;">
            <div class="col-12">
                <div class="homework-card p-4">
                    <h4 class="mb-3">
                        <i data-feather="eye" class="me-2"></i>Document Preview
                    </h4>
                    <div class="document-info mb-3" id="documentInfo">
                        <!-- Document info will be loaded here -->
                    </div>
                    <div class="document-preview" id="documentContent">
                        <!-- Document content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Ask Your Question Section -->
        <div class="row mb-4" id="askQuestionSection">
            <div class="col-12">
                <div class="homework-card p-4">
                    <h4 class="mb-3">
                        <i data-feather="message-circle" class="me-2"></i>Ask Your Question
                    </h4>
                    
                    <div class="question-input-area mb-3">
                        <textarea 
                            class="form-control" 
                            id="questionInput" 
                            placeholder="Type your question here or use the microphone button to speak..."
                            rows="4"
                        ></textarea>
                    </div>
                    
                    <div class="d-flex justify-content-center gap-3 mb-3">
                        <button class="btn btn-success" id="submitQuestion">
                            <i data-feather="check" class="me-2"></i>Submit Question
                        </button>
                        <button class="btn btn-primary" id="speakQuestion">
                            <i data-feather="mic" class="me-2"></i>Speak Question
                        </button>
                        <button class="btn btn-outline-secondary" id="cancelQuestion" style="display: none;">
                            <i data-feather="x" class="me-2"></i>Cancel
                        </button>
                    </div>
                    
                    <div class="mt-4" id="questionResponse" style="display: none;">
                        <div class="alert alert-info">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">
                                    <i data-feather="cpu" class="me-2"></i>Answer:
                                </h6>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" id="listenResponse">
                                        <i data-feather="volume-2" class="me-1"></i>Listen
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" id="stopAudio" style="display: none;">
                                        <i data-feather="square" class="me-1"></i>Stop
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" id="needHint" style="display: none;" onclick="requestHint(currentQuestion)">
                                        <i data-feather="help-circle" class="me-1"></i>Need a hint?
                                    </button>
                                </div>
                            </div>
                            <div id="responseText"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Questions Section -->
        <div class="row mb-4" id="questionsSection" style="display: none;">
            <div class="col-12">
                <div class="homework-card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0">
                            <i data-feather="help-circle" class="me-2"></i>Questions
                        </h4>
                        <div class="question-counter" id="questionCounter">
                            Question 1 of 5
                        </div>
                    </div>
                    
                    <div class="question-container" id="currentQuestion">
                        <!-- Current question will be loaded here -->
                    </div>
                    
                    <!-- Navigation -->
                    <div class="d-flex justify-content-between mt-4">
                        <button class="btn btn-outline-secondary" id="prevQuestion" disabled>
                            <i data-feather="arrow-left" class="me-2"></i>Previous
                        </button>
                        <button class="btn btn-primary" id="nextQuestion">
                            Next<i data-feather="arrow-right" class="ms-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Summary -->
        <div class="row mb-4" id="sessionSummary" style="display: none;">
            <div class="col-12">
                <div class="homework-card p-4">
                    <h4 class="mb-3">
                        <i data-feather="award" class="me-2"></i>Session Summary
                    </h4>
                    <div id="summaryContent">
                        <!-- Summary will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Initialize Feather icons
        feather.replace();

        // Global variables
        let currentSession = null;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let uploadedDocumentId = null;
        let selectedSubject = null;
        let selectedSessionType = 'homework';
        let speechRecognition = null;
        let isListening = false;
        let currentQuestion = null;
        let currentAudio = null;
        let currentHintLevel = 1;

        // Initialize speech recognition
        if ('webkitSpeechRecognition' in window) {
            speechRecognition = new webkitSpeechRecognition();
            speechRecognition.continuous = false;
            speechRecognition.interimResults = false;
        } else if ('SpeechRecognition' in window) {
            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = false;
            speechRecognition.interimResults = false;
        }

        // Session type selection
        document.querySelectorAll('input[name="sessionType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                selectedSessionType = this.value;
                updateSessionTypeBadge();
            });
        });

        // Subject selection
        document.querySelectorAll('input[name="subject"]').forEach(radio => {
            radio.addEventListener('change', function() {
                selectedSubject = this.value;
                updateSpeechRecognitionLanguage();
            });
        });

        function updateSessionTypeBadge() {
            const badge = document.getElementById('sessionTypeBadge');
            badge.className = 'session-type-badge session-type-' + selectedSessionType;
            
            const labels = {
                homework: 'Daily Homework',
                worksheet: 'Weekly Worksheet',
                exam: 'Exam Preparation'
            };
            
            badge.textContent = labels[selectedSessionType];
        }

        function updateSpeechRecognitionLanguage() {
            if (!speechRecognition) return;
            
            const languageMap = {
                'Hindi': 'hi-IN',
                'Telugu': 'te-IN',
                'English': 'en-IN'
            };
            
            speechRecognition.lang = languageMap[selectedSubject] || 'en-IN';
        }

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const documentFile = document.getElementById('documentFile');

        uploadArea.addEventListener('click', () => {
            if (!selectedSubject) {
                alert('Please select a subject first');
                return;
            }
            documentFile.click();
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            if (!selectedSubject) {
                alert('Please select a subject first');
                return;
            }
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        documentFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFileUpload(file);
            }
        });

        function handleFileUpload(file) {
            const allowedExtensions = ['.docx', '.txt', '.jpg', '.jpeg', '.png'];
            const fileExtension = file.name.toLowerCase().substr(file.name.lastIndexOf('.'));
            
            if (!allowedExtensions.includes(fileExtension)) {
                alert('Please upload a .docx, .txt, .jpg, .jpeg, or .png file only');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('subject', selectedSubject);
            formData.append('session_type', selectedSessionType);

            showUploadStatus();

            fetch('/api/homework/upload-document', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideUploadStatus();
                
                if (data.success) {
                    showUploadResult(data);
                    uploadedDocumentId = data.document_id;
                    currentQuestions = data.questions || [];
                    showDocumentPreview(data.document_id);
                    if (currentQuestions.length > 0) {
                        showQuestionsSection();
                    }
                } else {
                    alert('Error uploading document: ' + data.message);
                }
            })
            .catch(error => {
                hideUploadStatus();
                console.error('Upload error:', error);
                alert('Error uploading document');
            });
        }

        function showUploadStatus() {
            document.getElementById('uploadStatus').style.display = 'block';
            document.getElementById('uploadResult').style.display = 'none';
        }

        function hideUploadStatus() {
            document.getElementById('uploadStatus').style.display = 'none';
        }

        function showUploadResult(data) {
            const resultDiv = document.getElementById('uploadResult');
            const messageSpan = document.getElementById('uploadMessage');
            
            messageSpan.textContent = `Document uploaded successfully! ${data.pages_extracted || data.total_pages || 1} pages processed.`;
            resultDiv.style.display = 'block';
        }

        function showDocumentPreview(documentId) {
            if (!documentId) return;
            
            console.log('Loading document preview for ID:', documentId);
            
            fetch(`/api/document/${documentId}/pages`)
                .then(response => {
                    console.log('Document API response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Document API data:', data);
                    
                    if (data.document && data.pages) {
                        // Show document info
                        const docInfo = document.getElementById('documentInfo');
                        docInfo.innerHTML = `
                            <div class="alert alert-info">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Document:</strong> ${data.document.title || 'Uploaded Document'}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Pages:</strong> ${data.pages.length}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Show document content
                        const docContent = document.getElementById('documentContent');
                        let contentHtml = '';
                        
                        data.pages.forEach((page, index) => {
                            contentHtml += `
                                <div class="page-content mb-4">
                                    <h6 class="text-primary mb-2">Page ${page.page_number}</h6>
                                    <div class="content-text">${page.content.replace(/\n/g, '<br>')}</div>
                                </div>
                            `;
                        });
                        
                        docContent.innerHTML = contentHtml;
                        
                        // Show the document preview section
                        document.getElementById('documentPreview').style.display = 'block';
                        
                        feather.replace();
                    } else {
                        console.error('Invalid document data structure:', data);
                        showPreviewError('Invalid document data received');
                    }
                })
                .catch(error => {
                    console.error('Error loading document preview:', error);
                    showPreviewError('Unable to load document preview. Please try uploading again.');
                });
        }
        
        function showPreviewError(message) {
            const docInfo = document.getElementById('documentInfo');
            docInfo.innerHTML = `
                <div class="alert alert-warning">
                    <i data-feather="alert-triangle" class="me-2"></i>
                    ${message}
                </div>
            `;
            document.getElementById('documentPreview').style.display = 'block';
            feather.replace();
        }
        }

        function showQuestionsSection() {
            document.getElementById('questionsSection').style.display = 'block';
            loadCurrentQuestion();
        }

        function loadCurrentQuestion() {
            if (currentQuestions.length === 0) return;
            
            const question = currentQuestions[currentQuestionIndex];
            const questionContainer = document.getElementById('currentQuestion');
            
            questionContainer.innerHTML = `
                <div class="question-header mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Question ${currentQuestionIndex + 1}</h5>
                        <span class="badge bg-primary">${question.question_type || 'General'}</span>
                    </div>
                </div>
                
                <div class="question-text mb-4">
                    <p class="lead">${question.question_text}</p>
                    ${question.context ? `<small class="text-muted">Context: ${question.context}</small>` : ''}
                </div>
                
                <div class="answer-section">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label fw-bold">Your Answer:</label>
                        <button class="voice-button" onclick="startSpeechRecognition()" title="Speak your answer">
                            <i data-feather="mic" size="16"></i>
                        </button>
                    </div>
                    <textarea class="answer-textarea form-control" id="answerText" placeholder="Type your answer here or use the microphone button to speak..."></textarea>
                    
                    <div class="mt-3 d-flex gap-2">
                        <button class="btn btn-outline-warning" onclick="requestHint(1)">
                            <span class="hint-level-indicator hint-level-1">1</span>Need a hint?
                        </button>
                        <button class="btn btn-success" onclick="submitAnswer()">
                            <i data-feather="check" class="me-2"></i>Submit Answer
                        </button>
                    </div>
                </div>
                
                <div class="hints-section mt-4" id="hintsSection-${currentQuestionIndex}" style="display: none;">
                    <!-- Hints will be loaded here -->
                </div>
                
                <div class="feedback-section mt-4" id="feedbackSection-${currentQuestionIndex}" style="display: none;">
                    <!-- Feedback will be loaded here -->
                </div>
            `;
            
            // Update question counter
            document.getElementById('questionCounter').textContent = `Question ${currentQuestionIndex + 1} of ${currentQuestions.length}`;
            
            // Update navigation buttons
            document.getElementById('prevQuestion').disabled = currentQuestionIndex === 0;
            document.getElementById('nextQuestion').disabled = currentQuestionIndex === currentQuestions.length - 1;
            
            // Re-initialize feather icons
            feather.replace();
        }

        function startSpeechRecognition() {
            if (!speechRecognition) {
                alert('Speech recognition is not supported in your browser');
                return;
            }
            
            if (isListening) {
                speechRecognition.stop();
                return;
            }
            
            const micButton = event.target.closest('.voice-button');
            micButton.classList.add('listening');
            isListening = true;
            
            speechRecognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('answerText').value = transcript;
                micButton.classList.remove('listening');
                isListening = false;
            };
            
            speechRecognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                micButton.classList.remove('listening');
                isListening = false;
                alert('Speech recognition error: ' + event.error);
            };
            
            speechRecognition.onend = function() {
                micButton.classList.remove('listening');
                isListening = false;
            };
            
            speechRecognition.start();
        }

        function requestHint(level) {
            if (currentQuestions.length === 0) return;
            
            const question = currentQuestions[currentQuestionIndex];
            const hintsSection = document.getElementById(`hintsSection-${currentQuestionIndex}`);
            
            // Show loading state
            hintsSection.style.display = 'block';
            hintsSection.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="progress-ring me-3"></div>
                    <span>Generating hint...</span>
                </div>
            `;
            
            // Request hint from server
            fetch('/api/homework/process-question', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession?.session_id,
                    question: question.question_text,
                    request_hint: true,
                    hint_level: level
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.hint) {
                    displayHint(data.hint, level);
                } else {
                    hintsSection.innerHTML = '<div class="alert alert-warning">Unable to generate hint. Please try again.</div>';
                }
            })
            .catch(error => {
                console.error('Hint request error:', error);
                hintsSection.innerHTML = '<div class="alert alert-danger">Error requesting hint</div>';
            });
        }

        function displayHint(hint, level) {
            const hintsSection = document.getElementById(`hintsSection-${currentQuestionIndex}`);
            
            hintsSection.innerHTML = `
                <div class="alert alert-info">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="hint-level-indicator hint-level-${level}">${level}</span>
                            <strong>Hint Level ${level}</strong>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="listenToHint('${hint}')">
                            <i data-feather="volume-2" class="me-1"></i>Listen
                        </button>
                    </div>
                    <p class="mb-0">${hint}</p>
                </div>
                
                ${level < 5 ? `
                    <div class="mt-2">
                        <button class="btn btn-outline-warning btn-sm" onclick="requestHint(${level + 1})">
                            <span class="hint-level-indicator hint-level-${level + 1}">${level + 1}</span>
                            Need more help?
                        </button>
                    </div>
                ` : ''}
            `;
            
            feather.replace();
        }

        function listenToHint(hintText) {
            fetch('/api/homework/listen-hint', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    hint_text: hintText,
                    subject: selectedSubject
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.audio_url) {
                    const audio = new Audio(data.audio_url);
                    audio.play();
                } else {
                    alert('Unable to generate audio for hint');
                }
            })
            .catch(error => {
                console.error('Audio generation error:', error);
                alert('Error generating audio');
            });
        }

        function submitAnswer() {
            const answerText = document.getElementById('answerText').value.trim();
            
            if (!answerText) {
                alert('Please provide an answer');
                return;
            }
            
            const question = currentQuestions[currentQuestionIndex];
            const feedbackSection = document.getElementById(`feedbackSection-${currentQuestionIndex}`);
            
            // Show loading state
            feedbackSection.style.display = 'block';
            feedbackSection.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="progress-ring me-3"></div>
                    <span>Evaluating your answer...</span>
                </div>
            `;
            
            // Submit answer to server
            fetch('/api/homework/process-question', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession?.session_id,
                    question: question.question_text,
                    student_response: answerText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayFeedback(data);
                } else {
                    feedbackSection.innerHTML = '<div class="alert alert-danger">Error evaluating answer. Please try again.</div>';
                }
            })
            .catch(error => {
                console.error('Answer submission error:', error);
                feedbackSection.innerHTML = '<div class="alert alert-danger">Error submitting answer</div>';
            });
        }

        function displayFeedback(data) {
            const feedbackSection = document.getElementById(`feedbackSection-${currentQuestionIndex}`);
            
            const feedbackClass = data.evaluation_level === 'correct' ? 'feedback-positive' : 
                                 data.evaluation_level === 'partially_correct' ? 'feedback-partial' : 'feedback-negative';
            
            feedbackSection.innerHTML = `
                <div class="alert ${feedbackClass}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">
                            <i data-feather="${data.evaluation_level === 'correct' ? 'check-circle' : 'info'}" class="me-2"></i>
                            Feedback
                        </h6>
                        <span class="badge bg-secondary">${data.evaluation_level}</span>
                    </div>
                    <p class="mb-0">${data.feedback}</p>
                </div>
            `;
            
            feather.replace();
        }

        // Navigation functions
        document.getElementById('prevQuestion').addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadCurrentQuestion();
            }
        });

        document.getElementById('nextQuestion').addEventListener('click', () => {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                loadCurrentQuestion();
            } else {
                // All questions completed
                showSessionSummary();
            }
        });

        function showSessionSummary() {
            document.getElementById('questionsSection').style.display = 'none';
            document.getElementById('sessionSummary').style.display = 'block';
            
            // Load session summary
            const summaryContent = document.getElementById('summaryContent');
            summaryContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h5>Session Statistics</h5>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Total Questions</span>
                                <span class="badge bg-primary">${currentQuestions.length}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Session Type</span>
                                <span class="badge bg-info">${selectedSessionType}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Subject</span>
                                <span class="badge bg-success">${selectedSubject}</span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5>Next Steps</h5>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="location.reload()">
                                <i data-feather="refresh-cw" class="me-2"></i>Start New Session
                            </button>
                            <button class="btn btn-outline-secondary" onclick="window.location.href='/progress-report'">
                                <i data-feather="bar-chart" class="me-2"></i>View Progress Report
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            feather.replace();
        }

        // Question handling functions
        document.getElementById('submitQuestion').addEventListener('click', function() {
            const questionText = document.getElementById('questionInput').value.trim();
            
            if (!questionText) {
                alert('Please enter a question');
                return;
            }
            
            if (!selectedSubject) {
                alert('Please select a subject first');
                return;
            }
            
            submitUserQuestion(questionText);
        });
        
        document.getElementById('speakQuestion').addEventListener('click', function() {
            if (!selectedSubject) {
                alert('Please select a subject first');
                return;
            }
            
            startQuestionSpeechRecognition();
        });
        
        document.getElementById('clearQuestion').addEventListener('click', function() {
            document.getElementById('questionInput').value = '';
            document.getElementById('questionResponse').style.display = 'none';
            document.getElementById('needHint').style.display = 'none';
            currentQuestion = null;
            currentAudio = null;
        });
        
        // Add need hint functionality
        document.getElementById('needHint').addEventListener('click', function() {
            if (currentQuestion) {
                requestHint(currentQuestion);
            }
        });
        
        document.getElementById('listenResponse').addEventListener('click', function() {
            const responseText = document.getElementById('responseText').textContent;
            playResponseAudio(responseText);
        });
        
        // Add stop audio functionality
        document.getElementById('stopAudio').addEventListener('click', function() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
                document.getElementById('stopAudio').style.display = 'none';
                document.getElementById('listenResponse').style.display = 'inline-block';
            }
        });
        
        function startQuestionSpeechRecognition() {
            if (!speechRecognition) {
                alert('Speech recognition is not supported in your browser');
                return;
            }
            
            const speakButton = document.getElementById('speakQuestion');
            speakButton.classList.add('listening');
            speakButton.disabled = true;
            
            speechRecognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('questionInput').value = transcript;
                speakButton.classList.remove('listening');
                speakButton.disabled = false;
            };
            
            speechRecognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                speakButton.classList.remove('listening');
                speakButton.disabled = false;
                alert('Speech recognition error: ' + event.error);
            };
            
            speechRecognition.onend = function() {
                speakButton.classList.remove('listening');
                speakButton.disabled = false;
            };
            
            speechRecognition.start();
        }
        
        function submitUserQuestion(question) {
            const responseDiv = document.getElementById('questionResponse');
            const responseText = document.getElementById('responseText');
            
            // Show loading state
            responseDiv.style.display = 'block';
            responseText.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="progress-ring me-3"></div>
                    <span>Processing your question...</span>
                </div>
            `;
            
            // Submit question to AI tutor
            fetch('/api/homework/ask-question', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    document_id: uploadedDocumentId || null,
                    question: question,
                    subject: selectedSubject
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success !== false) {
                    // Store current question for hint functionality
                    currentQuestion = question;
                    currentHintLevel = 1;
                    
                    responseText.innerHTML = `
                        <div class="mb-3">
                            <strong>Answer:</strong>
                            <div class="mt-2">${formatSteps(data.answer || data.message)}</div>
                        </div>
                        ${data.page_references ? `
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i data-feather="bookmark" class="me-1"></i>
                                    References: ${data.page_references.join(', ')}
                                </small>
                            </div>
                        ` : ''}
                    `;
                    
                    // Show need hint button
                    document.getElementById('needHint').style.display = 'inline-block';
                    
                    // Update button group display
                    const btnGroup = document.getElementById('needHint').parentElement;
                    if (btnGroup) {
                        btnGroup.style.display = 'flex';
                    }
                    
                    feather.replace();
                } else {
                    responseText.innerHTML = `
                        <div class="alert alert-warning">
                            <i data-feather="alert-circle" class="me-2"></i>
                            ${data.message || 'Unable to process your question. Please try again.'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Question submission error:', error);
                responseText.innerHTML = `
                    <div class="alert alert-danger">
                        <i data-feather="alert-circle" class="me-2"></i>
                        Error processing your question. Please try again.
                    </div>
                `;
            });
        }
        
        function playResponseAudio(text) {
            fetch('/api/homework/listen-hint', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    hint_text: text,
                    subject: selectedSubject
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.audio_url) {
                    currentAudio = new Audio(data.audio_url);
                    
                    // Show stop button and hide listen button
                    document.getElementById('stopAudio').style.display = 'inline-block';
                    document.getElementById('listenResponse').style.display = 'none';
                    
                    // Handle audio end
                    currentAudio.onended = function() {
                        document.getElementById('stopAudio').style.display = 'none';
                        document.getElementById('listenResponse').style.display = 'inline-block';
                        currentAudio = null;
                    };
                    
                    currentAudio.play();
                } else {
                    alert('Unable to generate audio for response');
                }
            })
            .catch(error => {
                console.error('Audio generation error:', error);
                alert('Error generating audio');
            });
        }
        

        
        function requestHint(question) {
            const responseText = document.getElementById('responseText');
            
            // Show loading state
            responseText.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="progress-ring me-3"></div>
                    <span>Generating hint level ${currentHintLevel}...</span>
                </div>
            `;
            
            fetch('/api/homework/process-question', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession ? currentSession.session_id : null,
                    question: question,
                    request_hint: true,
                    hint_level: currentHintLevel
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    responseText.innerHTML = `
                        <div class="mb-3">
                            <strong>Hint Level ${currentHintLevel}:</strong>
                            <div class="mt-2">${formatSteps(data.hint_text)}</div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i data-feather="info" class="me-1"></i>
                                ${data.hint_explanation || 'Think about this hint and try to solve the problem!'}
                            </small>
                        </div>
                    `;
                    
                    // Increment hint level for next request
                    currentHintLevel = Math.min(currentHintLevel + 1, 5);
                    
                    feather.replace();
                } else {
                    responseText.innerHTML = `
                        <div class="alert alert-warning">
                            <i data-feather="alert-circle" class="me-2"></i>
                            Unable to generate hint. Please try again.
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Hint generation error:', error);
                responseText.innerHTML = `
                    <div class="alert alert-danger">
                        <i data-feather="alert-circle" class="me-2"></i>
                        Error generating hint. Please try again.
                    </div>
                `;
            });
        }
        
        function formatSteps(text) {
            if (!text) return text;
            
            // Convert step patterns to HTML
            text = text.replace(/\*\*Step (\d+):\*\*(.*?)(?=\*\*Step \d+:|\*\*Solution:|\*\*Answer:|$)/gs, 
                '<div class="step-item"><strong class="step-number">Step $1:</strong><div class="step-content">$2</div></div>');
            
            // Convert solution patterns
            text = text.replace(/\*\*Solution:\*\*(.*?)(?=\*\*Answer:|$)/gs, 
                '<div class="solution-item"><strong class="solution-header">Solution:</strong><div class="solution-content">$1</div></div>');
            
            // Convert answer patterns
            text = text.replace(/\*\*Answer:\*\*(.*?)$/gs, 
                '<div class="answer-item"><strong class="answer-header">Answer:</strong><div class="answer-content">$1</div></div>');
            
            // Convert general bold patterns
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Convert line breaks
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }
        
        function stopCurrentAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
                
                // Reset button display
                document.getElementById('stopAudio').style.display = 'none';
                document.getElementById('listenResponse').style.display = 'inline-block';
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Set default subject to English
            document.getElementById('english').checked = true;
            selectedSubject = 'English';
            updateSpeechRecognitionLanguage();
            
            // Initialize session type
            updateSessionTypeBadge();
            
            feather.replace();
        });
    </script>
</body>
</html>